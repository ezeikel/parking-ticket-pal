name: E2E Tests (Mobile)

on:
  push:
    branches: [main]

jobs:
  e2e-mobile:
    runs-on: macos-latest
    timeout-minutes: 45
    name: Maestro E2E Tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        env:
          FONTAWESOME_NPM_AUTH_TOKEN: ${{ secrets.FONTAWESOME_NPM_AUTH_TOKEN }}
        run: pnpm install --frozen-lockfile

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Boot iOS Simulator
        run: |
          DEVICE_ID=$(xcrun simctl list devices available -j | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for runtime, devices in data['devices'].items():
            if 'iOS' in runtime:
              for d in devices:
                if 'iPhone' in d['name'] and d['isAvailable']:
                  print(d['udid'])
                  sys.exit(0)
          ")
          xcrun simctl boot "$DEVICE_ID" || true
          echo "DEVICE_ID=$DEVICE_ID" >> $GITHUB_ENV

      - name: Build mobile app
        env:
          FONTAWESOME_NPM_AUTH_TOKEN: ${{ secrets.FONTAWESOME_NPM_AUTH_TOKEN }}
        working-directory: ./apps/mobile
        run: |
          pnpm prebuild:ios
          pnpm ios

      - name: Run Maestro manual entry flow
        working-directory: ./apps/mobile
        run: maestro test .maestro/ticket-manual-entry.yml

      - name: Upload Maestro artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: maestro-artifacts
          path: |
            ~/.maestro/tests/
          retention-days: 7
